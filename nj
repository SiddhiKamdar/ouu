package com.example.backend.repository;

import com.example.backend.entity.ExpensesDetail;
import org.springframework.data.jpa.repository.JpaRepository;

import java.util.List;

public interface ExpenseRepository
        extends JpaRepository<ExpensesDetail, Integer> {

    List<ExpensesDetail>
    findByEmployee_EmployeeId(int employeeId);

    List<ExpensesDetail>
    findByTravel_TravelId(int travelId);
}


public List<ExpenseResponseDTO>
getExpensesByTravel(Integer travelId) {

    Employee employee = getLoggedInEmployee();

    return expenseRepository
            .findByTravel_TravelId(travelId)
            .stream()
            .filter(e ->
                    e.getEmployee()
                     .getEmployeeId()
                     == employee.getEmployeeId())
            .map(this::mapToDTO)
            .toList();
}

@PreAuthorize("hasAuthority('ROLE_EMPLOYEE')")
@GetMapping("/travel/{travelId}")
public ResponseEntity<List<ExpenseResponseDTO>>
getExpensesByTravel(
        @PathVariable Integer travelId){

    return ResponseEntity.ok(
            expenseService
                    .getExpensesByTravel(travelId));
}



export const getExpensesByTravel =
async (travelId: string) => {

  const res =
    await axiosInstance.get(
      `/api/expenses/travel/${travelId}`
    );

  return res.data;
};


import React,
{ useEffect, useState } from "react";

import {
  getExpensesByTravel,
  submitExpense,
  Expense
} from "../../services/expenseService";

interface Props {
  travelId: string;
}

const TravelExpenses: React.FC<Props>
= ({ travelId }) => {

  const [expenses, setExpenses] =
    useState<Expense[]>([]);

  useEffect(() => {
    loadExpenses();
  }, [travelId]);

  const loadExpenses = async () => {
    const data =
      await getExpensesByTravel(travelId);
    setExpenses(data);
  };

  const handleSubmit =
  async (id:number) => {

    await submitExpense(id);
    loadExpenses();
  };

  return (

    <div className="mt-4">

      <h5>Expenses</h5>

      {expenses.length === 0 &&
        <p>No expenses added.</p>
      }

      <table className="table">

        <thead>
          <tr>
            <th>Type</th>
            <th>Amount</th>
            <th>Status</th>
            <th>Proof</th>
            <th>Action</th>
          </tr>
        </thead>

        <tbody>

        {expenses.map(e => (

          <tr key={e.expenseId}>

            <td>{e.expenseType}</td>
            <td>â‚¹ {e.amount}</td>
            <td>{e.status}</td>

            <td>
              <a
                href={`http://localhost:8080/${e.proofUrl}`}
                target="_blank"
              >
                View
              </a>
            </td>

            <td>
              {e.status === "DRAFT" && (
                <button
                  className="btn btn-success btn-sm"
                  onClick={() =>
                    handleSubmit(e.expenseId)}
                >
                  Submit
                </button>
              )}
            </td>

          </tr>
        ))}

        </tbody>

      </table>

    </div>
  );
};

export default TravelExpenses;

import TravelExpenses
from "../components/travel/TravelExpenses";

<hr />

<TravelExpenses
   travelId={travelId!}
/>
