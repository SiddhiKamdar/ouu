package com.example.backend.entity;

import jakarta.persistence.*;
import java.math.BigDecimal;
import java.util.Date;

@Entity
@Table(name = "expenses_detail")
public class ExpensesDetail {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    @Column(name = "expense_id")
    private int expenseId;

    @ManyToOne
    @JoinColumn(name = "travel_id", nullable = false)
    private Travel travel;

    @ManyToOne
    @JoinColumn(name = "expense_type_id", nullable = false)
    private ExpensesType expenseType;

    @ManyToOne
    @JoinColumn(name = "employee_id")
    private Employee employee;

    @Column(name = "amount", nullable = false)
    private BigDecimal amount;

    @Column(name = "comment")
    private String comment;

    @Column(name = "proof_url", nullable = false)
    private String proofUrl;

    @Column(name = "expense_date")
    private Date expenseDate;

    @Column(name = "upload_date")
    private Date uploadDate;

    @Column(name = "is_deleted")
    private Boolean isDeleted = false;

    // getters setters
}


@Entity
@Table(name = "expense_type")
public class ExpensesType {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    @Column(name = "expense_type_id")
    private int expenseTypeId;

    @Column(name = "expense_type_name")
    private String expenseTypeName;

    // getters setters
}


package com.example.backend.repository;

import com.example.backend.entity.ExpensesDetail;
import org.springframework.data.jpa.repository.JpaRepository;

import java.util.List;

public interface ExpenseRepository
        extends JpaRepository<ExpensesDetail, Integer> {

    List<ExpensesDetail> findByEmployee_EmployeeId(int employeeId);
}


package com.example.backend.repository;

import com.example.backend.entity.ExpensesType;
import org.springframework.data.jpa.repository.JpaRepository;

public interface ExpenseTypeRepository
        extends JpaRepository<ExpensesType, Integer> {
}

package com.example.backend.dto.request;

import java.math.BigDecimal;
import java.util.Date;

public class ExpenseRequestDTO {

    private int travelId;
    private int expenseTypeId;
    private BigDecimal amount;
    private String comment;
    private Date expenseDate;

    // getters setters
}


package com.example.backend.dto.response;

import java.math.BigDecimal;
import java.util.Date;

public class ExpenseResponseDTO {

    private int expenseId;
    private String travelDestination;
    private String expenseType;
    private BigDecimal amount;
    private String proofUrl;
    private Date expenseDate;

    public ExpenseResponseDTO(
            int expenseId,
            String travelDestination,
            String expenseType,
            BigDecimal amount,
            String proofUrl,
            Date expenseDate) {

        this.expenseId = expenseId;
        this.travelDestination = travelDestination;
        this.expenseType = expenseType;
        this.amount = amount;
        this.proofUrl = proofUrl;
        this.expenseDate = expenseDate;
    }

    // getters
}


@Service
public class ExpenseService {

    @Autowired
    private ExpenseRepository expenseRepository;

    @Autowired
    private TravelModuleRepository travelRepository;

    @Autowired
    private ExpenseTypeRepository expenseTypeRepository;

    @Autowired
    private EmployeeRepository employeeRepository;
public ExpenseResponseDTO createExpense(
        ExpenseRequestDTO request,
        MultipartFile proofFile) throws Exception {

    Authentication auth =
            SecurityContextHolder.getContext().getAuthentication();

    String email = auth.getName();

    Employee employee =
            employeeRepository.findByEmail(email)
                    .orElseThrow();

    Travel travel =
            travelRepository.findById(
                    (long) request.getTravelId())
                    .orElseThrow();

    ExpensesType type =
            expenseTypeRepository.findById(
                    request.getExpenseTypeId())
                    .orElseThrow();

    // ===== SAVE FILE =====
    String uploadDir =
            System.getProperty("user.dir")
                    + "/uploads/expense-proofs/";

    File dir = new File(uploadDir);
    if (!dir.exists()) dir.mkdirs();

    String fileName =
            System.currentTimeMillis()
                    + "_" +
                    proofFile.getOriginalFilename();

    proofFile.transferTo(
            new File(uploadDir + fileName));

    // ===== ENTITY =====
    ExpensesDetail expense = new ExpensesDetail();

    expense.setEmployee(employee);
    expense.setTravel(travel);
    expense.setExpenseType(type);
    expense.setAmount(request.getAmount());
    expense.setComment(request.getComment());
    expense.setExpenseDate(request.getExpenseDate());
    expense.setUploadDate(new Date());
    expense.setProofUrl(
            "uploads/expense-proofs/" + fileName
    );

    ExpensesDetail saved =
            expenseRepository.save(expense);

    return mapToDTO(saved);
}
public List<ExpenseResponseDTO> getMyExpenses() {

    Authentication auth =
            SecurityContextHolder.getContext().getAuthentication();

    String email = auth.getName();

    Employee employee =
            employeeRepository.findByEmail(email)
                    .orElseThrow();

    return expenseRepository
            .findByEmployee_EmployeeId(
                    employee.getEmployeeId())
            .stream()
            .map(this::mapToDTO)
            .toList();
}
private ExpenseResponseDTO mapToDTO(
        ExpensesDetail e) {

    return new ExpenseResponseDTO(
            e.getExpenseId(),
            e.getTravel().getDestination(),
            e.getExpenseType().getExpenseTypeName(),
            e.getAmount(),
            e.getProofUrl(),
            e.getExpenseDate()
    );
}




@RestController
@RequestMapping("/api/expenses")
public class ExpenseController {

    @Autowired
    private ExpenseService expenseService;
@PreAuthorize("hasAuthority('ROLE_EMPLOYEE')")
@PostMapping(
        value = "/create",
        consumes = MediaType.MULTIPART_FORM_DATA_VALUE
)
public ResponseEntity<ExpenseResponseDTO>
createExpense(
        @RequestPart("data")
        ExpenseRequestDTO request,

        @RequestPart("file")
        MultipartFile file
) throws Exception {

    return ResponseEntity.ok(
            expenseService.createExpense(
                    request, file));
}
@PreAuthorize("hasAuthority('ROLE_EMPLOYEE')")
@GetMapping("/my")
public ResponseEntity<List<ExpenseResponseDTO>>
getMyExpenses() {

    return ResponseEntity.ok(
            expenseService.getMyExpenses());
}
