import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.security.core.Authentication;

public List<TravelResponseDTO> getAllTravels() {

    Authentication authentication =
            SecurityContextHolder.getContext().getAuthentication();

    String email = authentication.getName();
    String role = authentication.getAuthorities()
            .iterator()
            .next()
            .getAuthority();   

    Employee loggedInUser = employeeRepository
            .findByEmail(email)
            .orElseThrow(() -> new RuntimeException("User not found"));

    if (role.equals("ROLE_HR")) {
        return travelRepository.findAll()
                .stream()
                .map(this::mapToDTO)
                .toList();
    }

    if (role.equals("ROLE_MANAGER")) {

        List<Employee> teamMembers =
                employeeRepository.findBySupervisor(loggedInUser);

        List<Integer> teamIds = teamMembers
                .stream()
                .map(Employee::getEmployeeId)
                .toList();

        return travelEmployeeRepository.findAll()
                .stream()
                .filter(te -> teamIds.contains(
                        te.getEmployee().getEmployeeId()))
                .map(te -> mapToDTO(te.getTravel()))
                .distinct()
                .toList();
    }

    return travelEmployeeRepository.findAll()
            .stream()
            .filter(te -> te.getEmployee()
                    .getEmployeeId()
                    == loggedInUser.getEmployeeId())
            .map(te -> mapToDTO(te.getTravel()))
            .distinct()
            .toList();
}



Optional<Employee> findByEmail(String email);

List<Employee> findBySupervisor(Employee supervisor);

