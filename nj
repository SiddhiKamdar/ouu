package com.example.backend.dto.response;

import java.util.Date;

public class TravelDocumentResponseDTO {

    private int id;
    private String documentUrl;
    private Date uploadedDate;
    private String uploadedByName;

    public TravelDocumentResponseDTO(
            int id,
            String documentUrl,
            Date uploadedDate,
            String uploadedByName
    ) {
        this.id = id;
        this.documentUrl = documentUrl;
        this.uploadedDate = uploadedDate;
        this.uploadedByName = uploadedByName;
    }

    public int getId() { return id; }
    public String getDocumentUrl() { return documentUrl; }
    public Date getUploadedDate() { return uploadedDate; }
    public String getUploadedByName() { return uploadedByName; }
}

public List<TravelDocumentResponseDTO> getDocumentsByTravel(int travelId)


import com.example.backend.dto.response.TravelDocumentResponseDTO;
import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.security.core.Authentication;

public List<TravelDocumentResponseDTO> getDocumentsByTravel(int travelId) {

    Authentication authentication =
            SecurityContextHolder.getContext().getAuthentication();

    String email = authentication.getName();
    String role = authentication.getAuthorities()
            .iterator()
            .next()
            .getAuthority();

    Employee loggedInUser = employeeRepository
            .findByEmail(email)
            .orElseThrow(() -> new RuntimeException("User not found"));

    List<TravelDocument> documents;

    // HR â†’ see all
    if (role.equals("ROLE_HR")) {
        documents = travelDocumentRepository
                .findByTravel_TravelId(travelId);
    }

    // MANAGER â†’ team documents
    else if (role.equals("ROLE_MANAGER")) {

        List<Employee> teamMembers =
                employeeRepository.findBySupervisor(loggedInUser);

        List<Integer> teamIds = teamMembers.stream()
                .map(Employee::getEmployeeId)
                .toList();

        documents = travelDocumentRepository
                .findByTravel_TravelId(travelId)
                .stream()
                .filter(doc -> {
                    if (doc.getEmployee() == null) return true;
                    return teamIds.contains(
                            doc.getEmployee().getEmployeeId()
                    );
                })
                .toList();
    }

    // EMPLOYEE â†’ general + own
    else {
        documents = travelDocumentRepository
                .findByTravel_TravelId(travelId)
                .stream()
                .filter(doc -> {
                    if (doc.getEmployee() == null) return true;
                    return doc.getEmployee().getEmployeeId()
                            == loggedInUser.getEmployeeId();
                })
                .toList();
    }

    // ðŸ”¥ Convert Entity â†’ DTO (THIS FIXES YOUR ERROR)
    return documents.stream()
            .map(doc -> new TravelDocumentResponseDTO(
                    doc.getId(),
                    doc.getDocumentUrl(),
                    doc.getUploadedDate(),
                    doc.getUploadedBy() != null
                            ? doc.getUploadedBy().getFullName()
                            : "System"
            ))
            .toList();
}




import com.example.backend.dto.response.TravelDocumentResponseDTO;

@PreAuthorize("hasAnyAuthority('ROLE_HR','ROLE_MANAGER','ROLE_EMPLOYEE')")
@GetMapping("/{travelId}")
public ResponseEntity<List<TravelDocumentResponseDTO>> getDocuments(
        @PathVariable int travelId) {

    return ResponseEntity.ok(
            travelDocumentService.getDocumentsByTravel(travelId)
    );
}




