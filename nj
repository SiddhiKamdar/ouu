import axiosInstance from "./axiosInstance";

export interface Expense {
  expenseId: number;
  employeeName: string;
  destination: string;
  amount: number;
  status: string;
  remark?: string;
  expenseDate: string;
  proofUrl: string;
}

export const uploadExpenseProof = async (
  file: File
): Promise<string> => {

  const formData = new FormData();
  formData.append("file", file);

  const response = await axiosInstance.post(
    "/api/expenses/upload-proof",
    formData,
    { headers: { "Content-Type": "multipart/form-data" } }
  );

  return response.data;
};

export const createExpense = async (data: {
  travelId: number;
  expenseTypeId: number;
  amount: number;
  proofUrl: string;
  comment?: string;
}) => {

  await axiosInstance.post("/api/expenses", data);
};

export const getMyExpenses = async (): Promise<Expense[]> => {

  const response =
    await axiosInstance.get("/api/expenses/my");

  return response.data;
};

import React, { useEffect, useState } from "react";
import {
  uploadExpenseProof,
  createExpense,
  getMyExpenses,
  Expense
} from "../services/expenseService";

interface Props {
  travelId: string;
}

const ExpenseSection: React.FC<Props> = ({ travelId }) => {

  const [file,setFile]=useState<File|null>(null);
  const [amount,setAmount]=useState("");
  const [comment,setComment]=useState("");
  const [expenses,setExpenses]=useState<Expense[]>([]);
  const [loading,setLoading]=useState(false);

  useEffect(()=>{
    loadExpenses();
  },[]);

  const loadExpenses=async()=>{
    const data=await getMyExpenses();
    setExpenses(data);
  };

  const handleSubmit=async()=>{

    if(!file || !amount) return;

    setLoading(true);

    const proofUrl=
      await uploadExpenseProof(file);

    await createExpense({
      travelId:Number(travelId),
      expenseTypeId:1,
      amount:Number(amount),
      proofUrl,
      comment
    });

    setFile(null);
    setAmount("");
    setComment("");

    await loadExpenses();

    setLoading(false);
  };

  return(

    <div>

      <h5>Add Expense</h5>

      <input
        type="number"
        className="form-control mb-2"
        placeholder="Amount"
        value={amount}
        onChange={e=>setAmount(e.target.value)}
      />

      <textarea
        className="form-control mb-2"
        placeholder="Comment"
        value={comment}
        onChange={e=>setComment(e.target.value)}
      />

      <input
        type="file"
        className="form-control mb-2"
        onChange={e=>
          setFile(e.target.files?.[0]||null)}
      />

      <button
        className="btn btn-success"
        disabled={loading}
        onClick={handleSubmit}
      >
        Submit Expense
      </button>

      <hr/>

      <h5>My Expenses</h5>

      {expenses.map(exp=>(
        <div
          key={exp.expenseId}
          className="border rounded p-2 mb-2"
        >

          <div>
            <strong>Amount:</strong> {exp.amount}
          </div>

          <div>
            <strong>Status:</strong> {exp.status}
          </div>

          {exp.remark && (
            <div>
              <strong>Remark:</strong> {exp.remark}
            </div>
          )}

          <a
            href={`http://localhost:8080/${exp.proofUrl}`}
            target="_blank"
          >
            View Proof
          </a>

        </div>
      ))}

    </div>
  );
};

export default ExpenseSection;


import React, { useEffect, useState } from "react";
import { useParams } from "react-router-dom";

import {
  getTravelById,
  Travel
} from "../services/travelService";

import {
  getDocumentsByTravel,
  uploadDocument,
  TravelDocument
} from "../services/documentService";

import ExpenseSection from "../components/ExpenseSection";

const TravelDetail:React.FC=()=>{

  const {travelId}=useParams();
  const user=
    JSON.parse(localStorage.getItem("user")||"{}");

  const [travel,setTravel]=
    useState<Travel|null>(null);

  const [documents,setDocuments]=
    useState<TravelDocument[]>([]);

  const [file,setFile]=
    useState<File|null>(null);

  const [activeTab,setActiveTab]=
    useState<"documents"|"expenses">
    ("documents");

  useEffect(()=>{
    if(travelId){
      loadTravel();
      loadDocuments();
    }
  },[]);

  const loadTravel=async()=>{
    const data=
      await getTravelById(travelId!);
    setTravel(data);
  };

  const loadDocuments=async()=>{
    const data=
      await getDocumentsByTravel(travelId!);
    setDocuments(data);
  };

  const handleUpload=async()=>{

    if(!file) return;

    await uploadDocument(
      travelId!,
      file,
      user.employeeId,
      user.role==="EMPLOYEE"
        ?user.employeeId
        :undefined
    );

    setFile(null);
    loadDocuments();
  };

  if(!travel) return<div>Loading...</div>;

  return(

    <div className="card p-4 shadow-sm">

      <h4>Travel Detail</h4>

      <p>
        <strong>Destination:</strong>
        {travel.destination}
      </p>

      <p>
        <strong>Employees:</strong>
        {travel.employeeNames?.join(", ")}
      </p>

      <hr/>

      <div className="mb-3">

        <button
          className={`btn me-2 ${
            activeTab==="documents"
            ?"btn-success"
            :"btn-outline-success"
          }`}
          onClick={()=>setActiveTab("documents")}
        >
          Documents
        </button>

        <button
          className={`btn ${
            activeTab==="expenses"
            ?"btn-success"
            :"btn-outline-success"
          }`}
          onClick={()=>setActiveTab("expenses")}
        >
          Expenses
        </button>

      </div>

      {activeTab==="documents"&&(

        <div>

          <ul>
            {documents.map(doc=>(
              <li key={doc.id}>
                <a
                 href={`http://localhost:8080/${doc.documentUrl}`}
                 target="_blank"
                >
                 {doc.documentUrl.split(/[/\\]/).pop()}
                </a>
              </li>
            ))}
          </ul>

          <input
            type="file"
            onChange={e=>
              setFile(
                e.target.files?.[0]||null)}
          />

          <button
            className="btn btn-success mt-2"
            onClick={handleUpload}
          >
            Upload
          </button>

        </div>
      )}

      {activeTab==="expenses"&&(
        <ExpenseSection
          travelId={travelId!}
        />
      )}

    </div>
  );
};

export default TravelDetail;



