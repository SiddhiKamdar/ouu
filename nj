package com.example.backend.service;

import com.example.backend.entity.*;
import com.example.backend.repository.*;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.math.BigDecimal;
import java.util.Date;
import java.util.List;

@Service
public class ExpenseService {

    @Autowired
    private ExpensesRepository expenseRepo;

    @Autowired
    private TravelModuleRepository travelRepo;

    @Autowired
    private EmployeeRepository employeeRepository;

    @Autowired
    private ExpensesReviewRepository reviewRepo;

    @Autowired
    private ApprovalStatusRepository statusRepo;

    @Autowired
    private LoggedInUserService loggedInUserService;

    @Autowired
    private NotificationService notificationService;

    @Autowired
    private EmailService emailService;



    public ExpensesDetail createExpense(
            Integer travelId,
            Integer expenseTypeId,
            BigDecimal amount,
            String comment,
            String proofUrl){

        if(proofUrl == null || proofUrl.isEmpty())
            throw new RuntimeException("Proof required");

        Travel travel =
                travelRepo.findById(travelId.longValue())
                        .orElseThrow();

        Date today = new Date();

        if(today.before(travel.getDepartDate()))
            throw new RuntimeException(
                    "Expense not allowed before travel start");

        long diff =
                today.getTime()
                        - travel.getReturnDate().getTime();

        long days = diff/(1000*60*60*24);

        if(days > 10)
            throw new RuntimeException(
                    "Expense submission window closed");

        Employee employee =
                loggedInUserService.getLoggedInEmployee();

        ExpensesDetail expense = new ExpensesDetail();
        expense.setTravel(travel);
        expense.setEmployee(employee);
        expense.setAmount(amount);
        expense.setComment(comment);
        expense.setProofUrl(proofUrl);
        expense.setUploadDate(today);
        expense.setExpenseDate(today);

        ExpensesDetail savedExpense =
                expenseRepo.save(expense);

        employeeRepository.findAll()
                .stream()
                .filter(e ->
                        e.getRole()
                                .getRoleName()
                                .equalsIgnoreCase("HR"))
                .forEach(hrEmployee -> {

                    notificationService.create(
                            hrEmployee,
                            "New Expense Submitted",
                            employee.getFullName()
                                    + " submitted expense for "
                                    + travel.getDestination()
                    );

                    emailService.sendMail(
                            hrEmployee.getEmail(),
                            "New Expense Submitted",
                            employee.getFullName()
                                    + " submitted expense for "
                                    + travel.getDestination()
                    );
                });

        return savedExpense;
    }



    public void approveExpense(
            Integer expenseId,
            Integer hrId){

        saveReview(expenseId, hrId, 2, null);
    }



    public void rejectExpense(
            Integer expenseId,
            Integer hrId,
            String remark){

        if(remark == null || remark.isEmpty())
            throw new RuntimeException("Remark required");

        saveReview(expenseId, hrId, 3, remark);
    }



    private void saveReview(
            Integer expenseId,
            Integer hrId,
            Integer statusId,
            String comment){

        ExpensesDetail expense =
                expenseRepo.findById(expenseId)
                        .orElseThrow();

        Employee reviewer =
                employeeRepository
                        .findById(hrId.longValue())
                        .orElseThrow();

        ApprovalStatus status =
                statusRepo.findById(statusId)
                        .orElseThrow();

        ExpensesReview review =
                new ExpensesReview();

        review.setExpense(expense);
        review.setReviewedBy(reviewer);
        review.setStatus(status);
        review.setComment(comment);

        reviewRepo.save(review);

        Employee expenseOwner =
                expense.getEmployee();

        notificationService.create(
                expenseOwner,
                "Expense Status Updated",
                "Your expense is "
                        + status.getApprovalStatusName()
        );

        emailService.sendMail(
                expenseOwner.getEmail(),
                "Expense Status Updated",
                "Your expense is "
                        + status.getApprovalStatusName()
                        + (comment != null
                        ? "\nRemark: " + comment
                        : "")
        );
    }



    public List<ExpensesDetail> getMyExpenses(){

        Employee emp =
                loggedInUserService.getLoggedInEmployee();

        return expenseRepo
                .findByEmployeeEmployeeId(
                        emp.getEmployeeId());
    }



    public List<ExpensesDetail> getAllExpenses(){
        return expenseRepo.findAll();
    }



    public List<ExpensesDetail> getTeamExpenses(){

        Employee manager =
                loggedInUserService.getLoggedInEmployee();

        List<Employee> teamMembers =
                employeeRepository
                        .findBySupervisor(manager);

        List<Integer> teamIds =
                teamMembers.stream()
                        .map(Employee::getEmployeeId)
                        .toList();

        return expenseRepo.findAll()
                .stream()
                .filter(exp ->
                        teamIds.contains(
                                exp.getEmployee()
                                        .getEmployeeId()))
                .toList();
    }
}
