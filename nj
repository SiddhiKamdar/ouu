import React, { useEffect, useState } from "react";
import { useParams } from "react-router-dom";
import axiosInstance from "../services/axiosInstance";
import { type Travel } from "../services/travelService";

interface TravelDocument {
  id: number;
  documentUrl: string;
  uploadedDate: string;
}

const TravelDetail: React.FC = () => {
  const { travelId } = useParams();
  const user = JSON.parse(localStorage.getItem("user") || "{}");

  const [travel, setTravel] = useState<Travel | null>(null);
  const [documents, setDocuments] = useState<TravelDocument[]>([]);
  const [selectedFile, setSelectedFile] = useState<File | null>(null);

  useEffect(() => {
    loadTravel();
    loadDocuments();
  }, []);

  const loadTravel = async () => {
    const response = await axiosInstance.get(`/api/travel/${travelId}`);
    setTravel(response.data);
  };

  const loadDocuments = async () => {
    const response = await axiosInstance.get(
      `/api/travel-documents/${travelId}`
    );
    setDocuments(response.data);
  };

  const handleFileChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    if (e.target.files) {
      setSelectedFile(e.target.files[0]);
    }
  };

  const handleUpload = async () => {
    if (!selectedFile) return;

    const formData = new FormData();
    formData.append("file", selectedFile);
    formData.append("travelId", travelId!);
    formData.append("uploadedById", user.employeeId);
    formData.append("documentTypeId", "1"); // temp static

    await axiosInstance.post(
      "/api/travel-documents/upload",
      formData,
      {
        headers: { "Content-Type": "multipart/form-data" }
      }
    );

    setSelectedFile(null);
    loadDocuments();
  };

  if (!travel) return <div>Loading...</div>;

  return (
    <div className="card p-4 shadow-sm">

      <h4>Travel Detail</h4>

      <p><strong>Destination:</strong> {travel.destination}</p>
      <p>
        <strong>Employees:</strong> {travel.employeeNames?.join(", ")}
      </p>
      <p>
        <strong>Departure:</strong>{" "}
        {new Date(travel.departDate).toLocaleDateString()}
      </p>
      <p>
        <strong>Return:</strong>{" "}
        {new Date(travel.returnDate).toLocaleDateString()}
      </p>

      <hr />

      <h5>Documents</h5>

      {documents.length === 0 && <p>No documents uploaded yet.</p>}

      <ul>
        {documents.map((doc) => (
          <li key={doc.id}>
            {doc.documentUrl.split("\\").pop()}
          </li>
        ))}
      </ul>

      <hr />

      <h5>Upload Document</h5>

      <input type="file" onChange={handleFileChange} />

      <button
        className="btn btn-primary mt-2"
        onClick={handleUpload}
      >
        Upload
      </button>

    </div>
  );
};

export default TravelDetail;
