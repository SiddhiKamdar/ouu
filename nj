import React, { useEffect, useState } from "react";
import FullCalendar from "@fullcalendar/react";
import timeGridPlugin from "@fullcalendar/timegrid";
import interactionPlugin from "@fullcalendar/interaction";

import {
  getGames,
  getSlots,
  applyForSlot,
  cancelBooking,
  completeSlot,
  type Game,
  type Slot
} from "../services/gameService";

const GameSchedule: React.FC = () => {

  const [games, setGames] = useState<Game[]>([]);
  const [selectedGame, setSelectedGame] = useState<number | null>(null);
  const [slots, setSlots] = useState<Slot[]>([]);

  const employeeId = Number(localStorage.getItem("employeeId"));
  const role = localStorage.getItem("role");

  useEffect(() => {
    loadGames();
  }, []);

  const loadGames = async () => {
    try {
      const data = await getGames();
      setGames(data);
    } catch (error) {
      console.error("Failed to load games", error);
    }
  };

  const handleGameSelect = async (gameId: number) => {
    setSelectedGame(gameId);
    loadSlots(gameId);
  };

  const loadSlots = async (gameId: number) => {
    try {
      const data = await getSlots(gameId);
      setSlots(data);
    } catch (error) {
      console.error("Failed to load slots", error);
    }
  };

  const refreshSlots = async () => {
    if (selectedGame) {
      await loadSlots(selectedGame);
    }
  };

  const calendarEvents = slots.map((slot) => {

    const start = `${slot.slotDate}T${slot.startTime}`;
    const end = `${slot.slotDate}T${slot.endTime}`;

    const getColor = () => {
      switch (slot.status) {
        case "OPEN":
          return "#28a745";
        case "BOOKED":
          return "#dc3545";
        case "COMPLETED":
          return "#6c757d";
        case "CANCELLED":
          return "#fd7e14";
        default:
          return "#0d6efd";
      }
    };

    return {
      id: slot.slotId.toString(),
      title: `${slot.startTime} - ${slot.endTime}`,
      start,
      end,
      backgroundColor: getColor(),
      borderColor: getColor(),
      textColor: "#ffffff",
      extendedProps: {
        status: slot.status
      }
    };
  });

  const handleEventClick = async (info: any) => {
    const slotId = Number(info.event.id);
    const status = info.event.extendedProps.status;

    try {
      if (status === "OPEN") {
        await applyForSlot({
          slotId,
          leaderEmpId: employeeId,
          members: [employeeId]
        });
        alert("Applied successfully");
        refreshSlots();
      }

      else if (status === "BOOKED") {
        await cancelBooking({
          slotId,
          cancelledByEmpId: employeeId
        });
        alert("Cancelled successfully");
        refreshSlots();
      }

      else if (status === "COMPLETED") {
        alert("Slot already completed");
      }

      if (role === "HR" && status === "BOOKED") {
        await completeSlot(slotId);
        alert("Slot marked completed");
        refreshSlots();
      }

    } catch (error) {
      console.error("Action failed", error);
      alert("Something went wrong");
    }
  };

  return (
    <div
      style={{
        minHeight: "100vh",
        backgroundColor: "#f4f6f9",
        padding: "30px"
      }}
    >
      <div className="container">

        <h2 className="mb-4">Game Scheduling</h2>

        <div className="mb-4">
          <label className="form-label">Select Game</label>
          <select
            className="form-select"
            onChange={(e) => handleGameSelect(Number(e.target.value))}
          >
            <option value="">Select Game</option>
            {games.map(game => (
              <option key={game.gameId} value={game.gameId}>
                {game.gameName}
              </option>
            ))}
          </select>
        </div>

        {selectedGame && (
          <div
            style={{
              backgroundColor: "#ffffff",
              padding: "25px",
              borderRadius: "10px",
              boxShadow: "0 4px 12px rgba(0,0,0,0.08)"
            }}
          >
            <FullCalendar
              plugins={[timeGridPlugin, interactionPlugin]}
              initialView="timeGridWeek"
              headerToolbar={{
                left: "prev,next today",
                center: "title",
                right: ""
              }}
              allDaySlot={false}
              slotMinTime="06:00:00"
              slotMaxTime="23:00:00"
              nowIndicator={true}
              expandRows={true}
              events={calendarEvents}
              eventClick={handleEventClick}
              height="75vh"
            />
          </div>
        )}

      </div>
    </div>
  );
};

export default GameSchedule;
