<dependency>
    <groupId>com.microsoft.sqlserver</groupId>
    <artifactId>mssql-jdbc</artifactId>
    <version>12.6.1.jre17</version>
</dependency>

dto/request/ApplySlotRequest.java
package com.example.backend.dto.request;

import java.util.List;

public class ApplySlotRequest {

    private int slotId;
    private int leaderEmpId;
    private List<Integer> members;

    public int getSlotId() {
        return slotId;
    }

    public void setSlotId(int slotId) {
        this.slotId = slotId;
    }

    public int getLeaderEmpId() {
        return leaderEmpId;
    }

    public void setLeaderEmpId(int leaderEmpId) {
        this.leaderEmpId = leaderEmpId;
    }

    public List<Integer> getMembers() {
        return members;
    }

    public void setMembers(List<Integer> members) {
        this.members = members;
    }
}

dto/request/CancelBookingRequest.java
package com.example.backend.dto.request;

public class CancelBookingRequest {

    private int slotId;
    private int cancelledByEmpId;

    public int getSlotId() {
        return slotId;
    }

    public void setSlotId(int slotId) {
        this.slotId = slotId;
    }

    public int getCancelledByEmpId() {
        return cancelledByEmpId;
    }

    public void setCancelledByEmpId(int cancelledByEmpId) {
        this.cancelledByEmpId = cancelledByEmpId;
    }
}

dto/response/GameResponse.java
package com.example.backend.dto.response;

public class GameResponse {

    private int gameId;
    private String gameName;

    public GameResponse(int gameId, String gameName) {
        this.gameId = gameId;
        this.gameName = gameName;
    }

    public int getGameId() {
        return gameId;
    }

    public String getGameName() {
        return gameName;
    }
}

dto/response/SlotResponse.java
package com.example.backend.dto.response;

public class SlotResponse {

    private int slotId;
    private String slotDate;
    private String startTime;
    private String endTime;
    private String status;

    public SlotResponse(int slotId, String slotDate,
                        String startTime, String endTime,
                        String status) {
        this.slotId = slotId;
        this.slotDate = slotDate;
        this.startTime = startTime;
        this.endTime = endTime;
        this.status = status;
    }

    public int getSlotId() { return slotId; }
    public String getSlotDate() { return slotDate; }
    public String getStartTime() { return startTime; }
    public String getEndTime() { return endTime; }
    public String getStatus() { return status; }
}

repository/GameSchedulingRepository.java
package com.example.backend.repository;

import com.example.backend.dto.request.ApplySlotRequest;
import com.example.backend.dto.response.GameResponse;
import com.example.backend.dto.response.SlotResponse;
import com.microsoft.sqlserver.jdbc.SQLServerCallableStatement;
import com.microsoft.sqlserver.jdbc.SQLServerDataTable;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.stereotype.Repository;

import java.sql.Connection;
import java.sql.Types;
import java.util.List;

@Repository
public class GameSchedulingRepository {

    private final JdbcTemplate jdbcTemplate;

    public GameSchedulingRepository(JdbcTemplate jdbcTemplate) {
        this.jdbcTemplate = jdbcTemplate;
    }

    // ---------------- READ ----------------

    public List<GameResponse> getGames() {
        return jdbcTemplate.query(
                "EXEC GetGames",
                (rs, rowNum) ->
                        new GameResponse(
                                rs.getInt("game_id"),
                                rs.getString("game_name")
                        )
        );
    }

    public List<SlotResponse> getAvailableSlots(int gameId) {
        return jdbcTemplate.query(
                "EXEC GetAvailableSlots @game_id = ?",
                new Object[]{gameId},
                (rs, rowNum) ->
                        new SlotResponse(
                                rs.getInt("slot_id"),
                                rs.getString("slot_date"),
                                rs.getString("start_time"),
                                rs.getString("end_time"),
                                rs.getString("status")
                        )
        );
    }

    // ---------------- APPLY (TVP) ----------------

    public void applyForSlot(ApplySlotRequest request) {

        jdbcTemplate.execute((Connection connection) -> {

            SQLServerDataTable tvp = new SQLServerDataTable();
            tvp.addColumnMetadata("emp_id", Types.INTEGER);

            for (Integer memberId : request.getMembers()) {
                tvp.addRow(memberId);
            }

            SQLServerCallableStatement cs =
                    (SQLServerCallableStatement)
                            connection.prepareCall("{call ApplyForSlot(?, ?, ?)}");

            cs.setInt(1, request.getSlotId());
            cs.setInt(2, request.getLeaderEmpId());

            cs.setStructured(3, "TeamMemberTableType", tvp);

            cs.execute();

            return null;
        });
    }

    // ---------------- CANCEL ----------------

    public void cancelBooking(int slotId, int cancelledByEmpId) {
        jdbcTemplate.update(
                "EXEC CancelBooking @slot_id = ?, @cancelled_by_emp_id = ?",
                slotId,
                cancelledByEmpId
        );
    }

    // ---------------- COMPLETE ----------------

    public void completeSlot(int slotId) {
        jdbcTemplate.update(
                "EXEC CompleteSlot @slot_id = ?",
                slotId
        );
    }
}

service/GameSchedulingService.java
package com.example.backend.service;

import com.example.backend.dto.request.ApplySlotRequest;
import com.example.backend.dto.request.CancelBookingRequest;
import com.example.backend.dto.response.GameResponse;
import com.example.backend.dto.response.SlotResponse;
import com.example.backend.repository.GameSchedulingRepository;
import org.springframework.stereotype.Service;

import java.util.List;

@Service
public class GameSchedulingService {

    private final GameSchedulingRepository repository;

    public GameSchedulingService(GameSchedulingRepository repository) {
        this.repository = repository;
    }

    public List<GameResponse> getGames() {
        return repository.getGames();
    }

    public List<SlotResponse> getAvailableSlots(int gameId) {
        return repository.getAvailableSlots(gameId);
    }

    public void applyForSlot(ApplySlotRequest request) {
        repository.applyForSlot(request);
    }

    public void cancelBooking(CancelBookingRequest request) {
        repository.cancelBooking(
                request.getSlotId(),
                request.getCancelledByEmpId()
        );
    }

    public void completeSlot(int slotId) {
        repository.completeSlot(slotId);
    }
}

controller/GameSchedulingController.java
package com.example.backend.controller;

import com.example.backend.dto.request.ApplySlotRequest;
import com.example.backend.dto.request.CancelBookingRequest;
import com.example.backend.dto.response.GameResponse;
import com.example.backend.dto.response.SlotResponse;
import com.example.backend.service.GameSchedulingService;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@RestController
@RequestMapping("/api/schedule")
public class GameSchedulingController {

    private final GameSchedulingService service;

    public GameSchedulingController(GameSchedulingService service) {
        this.service = service;
    }

    @GetMapping("/games")
    public List<GameResponse> getGames() {
        return service.getGames();
    }

    @GetMapping("/slots/{gameId}")
    public List<SlotResponse> getSlots(@PathVariable int gameId) {
        return service.getAvailableSlots(gameId);
    }

    @PostMapping("/apply")
    public ResponseEntity<String> apply(@RequestBody ApplySlotRequest request) {
        service.applyForSlot(request);
        return ResponseEntity.ok("Applied successfully");
    }

    @PostMapping("/cancel")
    public ResponseEntity<String> cancel(@RequestBody CancelBookingRequest request) {
        service.cancelBooking(request);
        return ResponseEntity.ok("Cancelled successfully");
    }

    @PostMapping("/complete/{slotId}")
    public ResponseEntity<String> complete(@PathVariable int slotId) {
        service.completeSlot(slotId);
        return ResponseEntity.ok("Slot completed successfully");
    }
}
