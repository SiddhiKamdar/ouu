public class ExpenseResponseDTO {

    private Integer expenseId;
    private String destination;
    private String expenseType;
    private BigDecimal amount;
    private String proofUrl;
    private Date expenseDate;
    private String status;
    private String hrRemark;

    public ExpenseResponseDTO(
            Integer expenseId,
            String destination,
            String expenseType,
            BigDecimal amount,
            String proofUrl,
            Date expenseDate,
            String status,
            String hrRemark) {

        this.expenseId = expenseId;
        this.destination = destination;
        this.expenseType = expenseType;
        this.amount = amount;
        this.proofUrl = proofUrl;
        this.expenseDate = expenseDate;
        this.status = status;
        this.hrRemark = hrRemark;
    }
}


@Service
public class ExpenseService {

    @Autowired
    private ExpenseRepository expenseRepository;

    @Autowired
    private TravelModuleRepository travelRepository;

    @Autowired
    private ExpenseTypeRepository expenseTypeRepository;

    @Autowired
    private EmployeeRepository employeeRepository;

    @Autowired
    private ApprovalStatusRepository approvalStatusRepository;

    @Autowired
    private ExpenseReviewRepository reviewRepository;


    // ================= CREATE =================
    public ExpenseResponseDTO createExpense(
            ExpenseRequestDTO request,
            MultipartFile proofFile) throws Exception {

        Authentication auth =
                SecurityContextHolder.getContext().getAuthentication();

        Employee employee =
                employeeRepository
                        .findByEmail(auth.getName())
                        .orElseThrow();

        Travel travel =
                travelRepository
                        .findById((long) request.getTravelId())
                        .orElseThrow();

        // ✅ TRAVEL OWNERSHIP CHECK
        boolean assigned =
                travel.getTravelEmployees()
                        .stream()
                        .anyMatch(te ->
                                te.getEmployee()
                                        .getEmployeeId()
                                        .equals(employee.getEmployeeId()));

        if (!assigned)
            throw new RuntimeException("Not assigned to this travel");


        // ✅ EXPENSE WINDOW CHECK
        Date today = new Date();

        Date start = travel.getDepartDate();

        Date end = new Date(
                travel.getReturnDate().getTime()
                        + (10L * 24 * 60 * 60 * 1000)
        );

        if (today.before(start) || today.after(end))
            throw new RuntimeException(
                    "Expense submission window closed");


        // ✅ FILE SAVE
        String uploadDir =
                System.getProperty("user.dir")
                        + "/uploads/expense-proofs/";

        File dir = new File(uploadDir);
        if (!dir.exists()) dir.mkdirs();

        String fileName =
                System.currentTimeMillis()
                        + "_" +
                        proofFile.getOriginalFilename();

        proofFile.transferTo(
                new File(uploadDir + fileName));

        ExpensesType type =
                expenseTypeRepository
                        .findById(request.getExpenseTypeId())
                        .orElseThrow();

        ApprovalStatus draftStatus =
                approvalStatusRepository.findById(1)
                        .orElseThrow();

        ExpensesDetail expense = new ExpensesDetail();

        expense.setEmployee(employee);
        expense.setTravel(travel);
        expense.setExpenseType(type);
        expense.setAmount(request.getAmount());
        expense.setComment(request.getComment());
        expense.setExpenseDate(request.getExpenseDate());
        expense.setUploadDate(new Date());
        expense.setProofUrl(
                "uploads/expense-proofs/" + fileName);
        expense.setApprovalStatus(draftStatus);

        return mapToDTO(
                expenseRepository.save(expense));
    }


    // ================= SUBMIT =================
    public void submitExpense(Integer expenseId) {

        ExpensesDetail expense =
                expenseRepository.findById(expenseId)
                        .orElseThrow();

        ApprovalStatus submitted =
                approvalStatusRepository
                        .findById(2)
                        .orElseThrow();

        expense.setApprovalStatus(submitted);

        expenseRepository.save(expense);
    }


    // ================= HR APPROVE =================
    public void approveExpense(Integer expenseId,
                               String remark) {

        Employee hr = getLoggedInEmployee();

        ExpensesDetail expense =
                expenseRepository.findById(expenseId)
                        .orElseThrow();

        ApprovalStatus approved =
                approvalStatusRepository
                        .findById(3)
                        .orElseThrow();

        expense.setApprovalStatus(approved);
        expenseRepository.save(expense);

        ExpenseReview review =
                new ExpenseReview();

        review.setExpense(expense);
        review.setReviewedBy(hr);
        review.setComment(remark);
        review.setReviewStatus(approved);

        reviewRepository.save(review);
    }


    // ================= HR REJECT =================
    public void rejectExpense(Integer expenseId,
                              String remark) {

        if (remark == null || remark.isBlank())
            throw new RuntimeException(
                    "Remark required");

        Employee hr = getLoggedInEmployee();

        ExpensesDetail expense =
                expenseRepository.findById(expenseId)
                        .orElseThrow();

        ApprovalStatus rejected =
                approvalStatusRepository
                        .findById(4)
                        .orElseThrow();

        expense.setApprovalStatus(rejected);
        expenseRepository.save(expense);

        ExpenseReview review =
                new ExpenseReview();

        review.setExpense(expense);
        review.setReviewedBy(hr);
        review.setComment(remark);
        review.setReviewStatus(rejected);

        reviewRepository.save(review);
    }


    // ================= EMPLOYEE VIEW =================
    public List<ExpenseResponseDTO> getMyExpenses() {

        Employee emp = getLoggedInEmployee();

        return expenseRepository
                .findByEmployee_EmployeeId(
                        emp.getEmployeeId())
                .stream()
                .map(this::mapToDTO)
                .toList();
    }


    private Employee getLoggedInEmployee() {

        Authentication auth =
                SecurityContextHolder
                        .getContext()
                        .getAuthentication();

        return employeeRepository
                .findByEmail(auth.getName())
                .orElseThrow();
    }


    private ExpenseResponseDTO mapToDTO(
            ExpensesDetail e) {

        String remark =
                reviewRepository.findAll()
                        .stream()
                        .filter(r ->
                                r.getExpense()
                                        .getExpenseId()
                                        .equals(e.getExpenseId()))
                        .map(ExpenseReview::getComment)
                        .findFirst()
                        .orElse(null);

        return new ExpenseResponseDTO(
                e.getExpenseId(),
                e.getTravel().getDestination(),
                e.getExpenseType()
                        .getExpenseTypeName(),
                e.getAmount(),
                e.getProofUrl(),
                e.getExpenseDate(),
                e.getApprovalStatus()
                        .getApprovalStatusName(),
                remark
        );
    }
}


@RestController
@RequestMapping("/api/expenses")
public class ExpenseController {

    @Autowired
    private ExpenseService expenseService;

    @PreAuthorize("hasAuthority('ROLE_EMPLOYEE')")
    @PostMapping(value="/create",
            consumes = MediaType.MULTIPART_FORM_DATA_VALUE)
    public ResponseEntity<?> create(
            @RequestPart("data")
            ExpenseRequestDTO request,
            @RequestPart("file")
            MultipartFile file) throws Exception {

        return ResponseEntity.ok(
                expenseService.createExpense(request,file));
    }

    @PreAuthorize("hasAuthority('ROLE_EMPLOYEE')")
    @PutMapping("/{id}/submit")
    public ResponseEntity<?> submit(
            @PathVariable Integer id){

        expenseService.submitExpense(id);
        return ResponseEntity.ok("Submitted");
    }


    @PreAuthorize("hasRole('HR')")
    @PutMapping("/{id}/approve")
    public ResponseEntity<?> approve(
            @PathVariable Integer id,
            @RequestParam String remark){

        expenseService.approveExpense(id,remark);
        return ResponseEntity.ok("Approved");
    }

    @PreAuthorize("hasRole('HR')")
    @PutMapping("/{id}/reject")
    public ResponseEntity<?> reject(
            @PathVariable Integer id,
            @RequestParam String remark){

        expenseService.rejectExpense(id,remark);
        return ResponseEntity.ok("Rejected");
    }

    @PreAuthorize("hasAuthority('ROLE_EMPLOYEE')")
    @GetMapping("/my")
    public ResponseEntity<?> myExpenses(){
        return ResponseEntity.ok(
                expenseService.getMyExpenses());
    }
}


